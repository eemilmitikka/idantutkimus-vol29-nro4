---
title: "Untitled"
author: "Eemil Mitikka"
date: "2022-11-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Lueminut: Ohjeet replikaatioanalyysien toteuttamiseksi

Tämä dokumentti sisältää replikaatiokoodit R-ohjelmointikielellä (versio: `r paste(version$version.string)`) ja RStudiolla (versio: 2022.7.0.548) tehtyihin visualisointeihin ja data-analyyseihin Idäntutkimuksen "Ääni"-teemanumeroon kirjoitettuun artikkeliin. Tämä R Markdown-tiedosto sisältää yhteensä seitsemän eri kuvan replikaatiokoodit. Jos replikaatioanalyysin tekijä (esim. vertaisarvioija) on kiinnostunut ensisijaisesti tutkimukseni tilastollisten mallien tarkastelusta, suosittelen siirtymään suoraan **Kuva 5**, **Kuva 6** ja **Kuva 7** otsikoilla otsikoituihin osioihin. Huomioithan kuitenkin, että sinun on ensin ajettava otsikon **R-paketit, teemat, yms.** alla oleva koodinpätkä mm. R-pakettien, analyysissä käytettyjen teemojen ja vastaavien aktivoimiseksi -- ilman tätä tilastollisten mallien replikaatiokoodi ei toimi.

Dokumentti on koostettu siten, että parsimalla tiedoston kasaan -- Knit-nappi tai Shift+Command+K (MacOS) / Shift+Control+K (Windows) -- kaikkien koodien pitäisi toimia ja tuottaa haluttu tulos.

Tilastollisten mallien analyysit on tehty staattisten kyselytutkimusaineistojen pohjalta. Nämä aineistot ovat avoimesti ladattavissa seuraavista linkeistä (toimivuus tarkistettu 31.8.2022):

* Chronicles: projektin [GitHub-sivut](https://github.com/dorussianswantwar/research1)
* Russian Field: projektin nettisivut
  - [26--28 helmikuuta 2022 tehty sotakysely](https://drive.google.com/file/d/1JslJAa062JV60FVGKjYtcF_93SMXfQgD/view)
  - [5--7 maaliskuuta 2022 tehty sotakysely](https://drive.google.com/file/d/1EvOioLSvfiDi5SHsnYCbCcuPS8pgWTx0/view)
  - [13--16 maaliskuuta 2022 tehty sotakysely](https://drive.google.com/file/d/1IGNkysodMW9SyONXHO6yGOFPDE08IsXK/view)
  - [23--26 toukokuuta 2022 tehty sotakysely](https://drive.google.com/file/d/1bL6dwGZjtwTspdt_bPmUyxAwtuo91WOc/view)
* VTSIOM: kyselytutkimuslaitoksen nettisivut, suoralinkit tässä käytettyihin aineistoihin:
  - [Специальная военная операция в Украине: отношение и цели](https://wciom.ru/analytical-reviews/analiticheskii-obzor/specialnaja-voennaja-operacija-v-ukraine-otnoshenie-i-celi) ... Материалы ... Массив данных
  - [Специальная военная операция: мониторинг | 23 марта 2022](https://wciom.ru/analytical-reviews/analiticheskii-obzor/specialnaja-voennaja-operacija-monitoring) ... Материалы ... Массив данных
  - [Cпециальная военная операция: мониторинг | 30 марта 2022](https://wciom.ru/analytical-reviews/analiticheskii-obzor/cpecialnaja-voennaja-operacija-monitoring-20220330) ... Материалы ... Массив данных
  - [Cпециальная военная операция: мониторинг | 30 мая 2022](https://wciom.ru/analytical-reviews/analiticheskii-obzor/cpecialnaja-voennaja-operacija-monitoring) ... Материалы ... Массив данных
  - [Специальная военная операция: мониторинг | 30 июня 2022](https://wciom.ru/analytical-reviews/analiticheskii-obzor/specialnaja-voennaja-operacija-monitoring-20223006) ... Материалы ... Массив данных
  
Tallensin itse kaikki tässä käytetyt datasetit `data` nimiseen kansioon, jonka vuoksi työhakemisto (*working directory*) kulkee tässä käytetyn **here-paketin** logiikalla seuraavasti: `here("data/tiedostonimi.tiedostoformaatti")`, jne. Replikaatioanalyysiä tehdessä tiedostopolku on siis luonnollisesti määriteltävä oman paikallisen työhakemiston mukaan.

# R-paketit, teemat, yms.

```{r warning=FALSE, message=FALSE}
library(tidyverse)
library(survey)
library(rvest)
library(lubridate)
library(patchwork)
library(here)
library(haven)
library(janitor)
library(broom)

theme_oma <- function() {
  font <- "Times" # assign font family up front
  theme_minimal() %+replace% # replace elements we want to change
    theme(
      # Plot grids color
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      # Text elements
      plot.title = element_text(
        family = font,
        size = 18,
        face = 'bold',
        hjust = 0,
        vjust = 2,
        margin = margin(15,0,0,0)),
      
      plot.subtitle = element_text( # title
                   family = font, # set font family
                   face = 'bold', # bold typeface
                   size = 14), # size of the title
      # Plot caption
      plot.caption = element_text(
        family = font,
        size = 10,
        face = 'bold',
        hjust = 1,
        colour = "#61605A"),
      # Axis title
      axis.title = element_text(
        family = font,
        size = 12),
      axis.text = element_text(
        family = font,
        face = 'bold',
        size = 12),
      axis.text.x = element_text(
        margin = margin(5, b = 10)),
      # Legend elements
      legend.title = element_text(
        family = font,
        size = 10,
        face = "bold"),
      legend.text = element_text(
        family = font,
        size = 8,
        face = "bold")
    )
}

# Regression coefficients title
coefs <- "Regressiokertoimet\nSelitettävä muuttuja = sodan kannatus"
odds <- "Riskiluvut\nSelitettävä muuttuja = sodan kannatus"



vihrea <- "#51A195"
punainen <- "#C56053"
harmaa <- "#8C8D8D"

tuen <- "#4B88CB"
en_tue <- "#E66826"
eos <- "#949494"

```

# Kuva 1

```{r}
# Import Levada-Center data
levada_data <- data.frame(date = as.Date(c("2022-03-01", "2022-04-01", "2022-05-01", "2022-06-01")),
           definitely_yes = c(0.53, 0.45, 0.47, 0.47),
           rather_yes = c(0.28, 0.29, 0.30, 0.28),
           rather_no = c(0.08, 0.08, 0.08, 0.11),
           definitely_no = c(0.06, 0.11, 0.09, 0.09),
           no_answer = c(0.06, 0.07, 0.06, 0.05))

# Wrangle Levada data
levada_data <- levada_data %>% 
  gather(key = "support", val = "prc", definitely_yes:no_answer) %>% 
  mutate(date = as.factor(date))

levada_data$support <- factor(levada_data$support,
                              levels = rev(c("definitely_yes", 
                                             "rather_yes",
                                             "rather_no",
                                             "definitely_no",
                                             "no_answer")))

ehd_tuen <- "#355BB7"
tuen <- "#4B88CB"
en_tue <- "#FDB409"
ehd_en_tue <- "#E66826"
eos <- "#949494"

paletti_levada <- c(eos, ehd_en_tue, en_tue, tuen, ehd_tuen)

# Plot Levada data
levada_sotakannatus <-
  levada_data %>% 
  ggplot(aes(x = date, y = prc, fill = support)) +
  geom_col() +
  theme_oma() +
  geom_text(aes(label = paste0(prc*100,"%")),
            position = position_stack(vjust = 0.5),
            size = 4,
            fontface = "bold",
            family = "Times",
            color = ifelse(levada_data$support == "definitely_yes", "white", "black")
            ) +
  scale_fill_manual(
    values = paletti_levada,
    labels = rev(c("Ehdottomasti tuen", 
                   "Ennemmin tuen",
                   "Ennemmin en tue",
                   "Ehdottomasti en tue",
                   "Ei vastausta"))) +
  scale_x_discrete(labels = c("24.3.–30.3.", "21.4.–27.4.", "26.5.–31.5.", "23.6.–29.6.")) +
  theme(axis.text.y = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_text(angle = 30,
                                   size = 13),
        legend.title = element_text(face = "bold.italic",
                                    size = 14),
        legend.text = element_text(size = 12)
        ) +
  labs(fill = toupper("Sodan kannatus"),
       title = 'LEVADA-KESKUS: "Tuetteko vai ettekö tue Venäjän\nasevoimien toimia Ukrainassa?"')

# VTSIOM: import war support data by scraping the data from website
vtsiom_link_1 <- "https://wciom.ru/analytical-reviews/analiticheskii-obzor/cpecialnaja-voennaja-operacija-monitoring"
vtsiom_page_1 <- read_html(vtsiom_link_1)
# VTSIOM: Import the table
vtsiom_sotakannatus_1 <- 
  vtsiom_page_1 %>% 
  html_elements("table.contenttable") %>% 
  html_table() %>% 
  .[[1]] %>% 
  as.data.frame() %>% 
  rename(support = "") %>% 
  gather(key = "date", val = "prosentti_vtsiom", `25.II`:`26.V`) %>% 
  mutate(date = as.factor(c(rep("25.2.", 3), 
                  rep("27.2.", 3),
                  rep("3.3.", 3),
                  rep("17.3.", 3),
                  rep("24.3.", 3),
                  rep("12.4.", 3),
                  rep("24.4.", 3),
                  rep("12.5.", 3),
                  rep("26.5.", 3))),
         prosentti_vtsiom = 0.01 * prosentti_vtsiom)

# Import second part of VTSIOM data
vtsiom_link_2 <- "https://wciom.ru/analytical-reviews/analiticheskii-obzor/specialnaja-voennaja-operacija-monitoring-20223006"
vtsiom_page_2 <- read_html(vtsiom_link_2)

vtsiom_sotakannatus_2 <- 
  vtsiom_page_2 %>% 
  html_elements("table.contenttable") %>% 
  html_table() %>% 
  .[[1]] %>% 
  as.data.frame() %>% 
  rename(support = "") %>% 
  select(support, "12.VI", "25.VI") %>% 
  gather(key = "date", val = "prosentti_vtsiom", `12.VI`:`25.VI`) %>% 
  mutate(date = as.factor(c(rep("12.6.", 3),
                            rep("25.6.", 3))),
         prosentti_vtsiom = 0.01 * prosentti_vtsiom)

# Merge VTSIOM datasets
vtsiom_sotakannatus <- vtsiom_sotakannatus_1 %>% 
  full_join(vtsiom_sotakannatus_2)

vtsiom_sotakannatus$date2 <- dmy(c(rep("25.2.2022", 3),
                              rep("27.2.2022", 3),
                               rep("3.3.2022", 3),
                               rep("17.3.2022", 3),
                               rep("24.3.2022", 3),
                               rep("12.4.2022.", 3),
                               rep("24.4.2022", 3),
                               rep("12.5.2022", 3),
                               rep("26.5.2022", 3), 
                               rep("12.6.2022", 3), 
                               rep("25.6.2022", 3)))
# Plot VTSIOM war support data
vtsiom_pvm <- c("25.2.", "27.2.", "3.3.", "17.3.", "24.3.", "12.4.", "24.4.", "12.5.", "26.5.", "12.6.", "25.6.")

vihrea <- "#51A195"
punainen <- "#C56053"
harmaa <- "#8C8D8D"

tuen <- "#4B88CB"
en_tue <- "#E66826"
eos <- "#949494"

paletti_vtsiom <- c(eos, en_tue, tuen)


vtsiom_sotakannatus_kuva <-
  vtsiom_sotakannatus %>% 
  ggplot(aes(x = as.factor(date2), y = prosentti_vtsiom, fill = support)) +
  geom_col() +
  theme_oma() +
  geom_text(aes(label = paste0(prosentti_vtsiom*100,"%")),
            position = position_stack(vjust = 0.5),
            size = 4,
            fontface = "bold",
            family = "Times"
            ) +
  scale_fill_manual(values = paletti_vtsiom,
                    labels = rev(c("Ennemmin tuen", "Ennemmin en tue", "Ei vastausta"))) +
  scale_x_discrete(labels = vtsiom_pvm) +
  theme(axis.text.y = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_text(angle = 30,
                                   size = 13),
        legend.title = element_text(face = "bold.italic",
                                    size = 14),
        legend.text = element_text(size = 12)
        ) +
  labs(fill = toupper("Sodan kannatus"),
       title = 'VTSIOM: "Tuetteko vai ettekö tue Venäjän päätöstä toteuttaa sotilaallinen erikoisoperaatio Ukrainassa?"')
  

# FOM: define war support data "by hand" (information retrieved from their website)
fom_data <- data.frame(support = as.factor(c(1, 1, 1, 1, 2, 2, 2, 2, 99, 99, 99, 99)),
           date = rep(as.factor(c("2022-02-27", "2022-03-06", "2022-03-13", "2022-03-20")), times = 3),
           prosentti_fom = c(0.65, 0.68, 0.68, 0.73, 0.17, 0.15, 0.12, 0.14, 0.18, 0.16, 0.20, 0.14))

fom_data <-
  data.frame(prosentti_fom = c(0.65, 0.68, 0.68, 0.73,
                               0.17, 0.15, 0.12, 0.14,
                               0.18, 0.16, 0.20, 0.14),
             support = as.factor(c(rep("Oikea päätös", 4), 
                                   rep("Väärä päätös", 4),
                                   rep("En osaa sanoa", 4))),
             date = ymd(c("2022-02-27",
                          "2022-03-06",
                          "2022-03-13",
                          "2022-03-20")))

fom_data <- 
  fom_data %>% 
  mutate(support = fct_relevel(support, rev(c("Oikea päätös", "Väärä päätös", "En osaa sanoa"))))

# Plot the FOM data
fom_sotakannatus <-
  fom_data %>% 
  ggplot(aes(x = as.factor(date), y = prosentti_fom, fill = support)) +
  geom_col() +
  theme_oma() +
  geom_text(aes(label = paste0(prosentti_fom*100,"%")),
            position = position_stack(vjust = 0.5),
            size = 4,
            fontface = "bold",
            family = "Times",
            color = ifelse(fom_data$support == "1", "white", "black")) +
  scale_fill_manual(
    # values = rev(c(musta, keski_harmaa, vaalea_harmaa)),
    values = paletti_vtsiom,
                    labels = rev(c("Oikea päätös", "Väärä päätös", "En osaa sanoa"))) +
    theme(axis.text.y = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_text(angle = 30,
                                   size = 13),
        legend.title = element_text(face = "bold.italic",
                                    size = 14),
        legend.text = element_text(size = 12)
        ) +
  scale_x_discrete(labels = c("27.2.", "6.3.", "13.3.", "20.3.")) +
  labs(fill = toupper("Sodan kannatus"),
       title = 'FOM: "Oliko päätös aloittaa sotilasoperaatio Ukrainassa\noikein vai väärin?"')

# Russian Field wave 1
rf_data_1 <- here::here("data/“RF_26-28.02.2022”.sav") %>% 
  haven::read_spss() %>% 
  janitor::clean_names() %>% 
  mutate(support = as.factor(q11),
         date = as.factor("26.2.–28.2.")) %>% 
  select(support, date, vtpv)

# Russian Field wave 2
rf_data_2 <- here::here("data/МАССИВ SPSS Russian Field - _Россия-Украина_ (всероссийский телефонный опрос, 1600, 5-7 марта).sav") %>% 
  haven::read_spss() %>% 
  janitor::clean_names() %>% 
  mutate(support = as.factor(q5),
         date = as.factor("5.3.–7.3.")) %>% 
  select(support, date, vtpv)

# Russian Field wave 3
rf_data_3 <- here::here("data/Массив spss 13-16 марта RF.sav") %>% 
  haven::read_spss() %>% 
  janitor::clean_names() %>% 
  mutate(support = as.factor(q5),
         date = as.factor("13.3.–16.3.")) %>% 
  select(support, date, vtpv)

# Russian Field wave 7
rf_data_4 <- here::here("data/Массив_7_Волна_Russian Field.sav") %>% 
  haven::read_spss() %>% 
  janitor::clean_names() %>% 
  mutate(support = as.factor(q17),
         date = as.factor("23.5.–26.5.")) %>% 
  select(support, date, vtpv)

# Merge Russian Field data
rf_all <- rbind(rf_data_1, rf_data_2, rf_data_3, rf_data_4)

# Russian Field: define design
rf_all_design <- svydesign(ids =~ 1,
                           data = rf_all,
                           weights = rf_all$vtpv)

# Russian Field: calculate percentages
rf_all <- svytable(~support + date, design = rf_all_design) %>% 
  as.data.frame() %>% 
  group_by(date) %>% 
  mutate(prc = round(100*Freq / sum(Freq), digits = 0)) %>% 
  filter(prc != 0)

rf_pvm1 <- "26.2.–28.2."
rf_pvm2 <- "5.3.–7.3."
rf_pvm3 <- "13.3.–16.3."
rf_pvm4 <- "23.5.–26.5."

rf_all$date <- factor(rf_all$date,
                      levels = c(rf_pvm1, rf_pvm2, rf_pvm3, rf_pvm4))

kieltaytyy <- punainen
keltainen <- "#FDB409"

paletti_rf <- c(kieltaytyy, eos, ehd_en_tue, keltainen, tuen, ehd_tuen)

# Russian Field: plot overall war support
rf_sotakannatus <-
  rf_all %>% 
  ggplot(aes(x = date, y = prc, fill = fct_rev(support))) +
  geom_col() +
  theme_oma() +
  geom_text(aes(label = paste(prc, "%")),
            position = position_stack(vjust = 0.5),
            size = 4,
            fontface = "bold",
            family = "Times",
            color = ifelse(rf_all$support == "1", "white", "black")
            ) +
  scale_fill_manual(values = paletti_rf,
                    labels = rev(c("Ehdottomasti tuen", "Ennemmin tuen", "Ennemmin en tue", "Ehdottomasti en tue", "En osaa sanoa", "Kieltäytyy vastaamasta"))) +
  theme(axis.text.y = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_text(angle = 30,
                                   size = 13),
        legend.title = element_text(face = "bold.italic",
                                    size = 14),
        legend.text = element_text(size = 12)
        ) +
  labs(fill = toupper("Sodan kannatus"),
       title = 'RUSSIAN FIELD: "Tuetteko Venäjän joukkojen sotilasoperaatiota\nUkrainan alueella?"')

# Chonicles data date vectors
chronicles_pvm1 <- as.factor("28.2.–2.3.")
chronicles_pvm2 <- as.factor("10.3.–13.3.")
chronicles_pvm3 <- as.factor("26.3.–30.3.")
chronicles_pvm4 <- as.factor("10.4.–18.4.")
chronicles_pvm5 <- as.factor("14.5.–19.5.")
chronicles_pvm6 <- as.factor("29.6.–5.7.")
chronicles_pvm7 <- as.factor("21.9.–22.9.")
chronicles_pvm8 <- as.factor("29.9.–30.9.")

# Chronicles data imports
chronicles_1 <- here::here("data/Полные Хроники 1.0 Datatile.sav") %>% 
  haven::read_spss() %>%
  janitor::clean_names() %>% 
  mutate(support = as.factor(q4),
         date = chronicles_pvm1) %>% 
  select(support, date, wes_age_gender_tnp)

chronicles_2 <- here::here("data/Полные Хроники 2.0 Datatile.sav") %>% 
  haven::read_spss() %>% 
  janitor::clean_names() %>% 
  mutate(support = as.factor(q11),
         date = chronicles_pvm2) %>% 
  select(support, date, wes_age_gender_tnp)

chronicles_3 <- here::here("data/Полные Хроники 3.0 Datatile.sav") %>% 
  haven::read_spss() %>% 
  janitor::clean_names() %>% 
  mutate(support = as.factor(q23),
         date = chronicles_pvm3) %>% 
  select(support, date, wes_age_gender_tnp)

chronicles_4 <- here::here("data/Полные Хроники 4.0 Datatile.sav") %>% 
  haven::read_spss() %>% 
  janitor::clean_names() %>% 
  mutate(support = as.factor(q23),
         date = chronicles_pvm4) %>% 
  select(support, date, wes_age_gender_tnp)

chronicles_5 <- here::here("data/Полные Хроники 5.0.sav") %>% 
  haven::read_spss() %>% 
  janitor::clean_names() %>% 
  mutate(support = as.factor(q21),
         date = chronicles_pvm5) %>% 
  select(support, date, wes_age_gender_tnp)

chronicles_6 <- here::here("data/Полные Хроники 6.0 Datatile.sav") %>% 
  haven::read_spss() %>% 
  janitor::clean_names() %>% 
  # rdhs::get_variable_labels()
  mutate(support = as.factor(q22),
         date = chronicles_pvm6) %>% 
  select(support, date, wes_age_gender_tnp)

chronicles_7 <-
  here::here("data/Полные Хроники Экспресс 1 Datatile.sav") %>% 
  haven::read_spss() %>% 
  janitor::clean_names() %>% 
  mutate(support = as.factor(q5),
         date = chronicles_pvm7) %>% 
  select(support, date, wes_age_gender_tnp)

chronicles_8 <- 
  here::here("data/Полные Хроники Экспресс 2 Datatile.sav") %>% 
  haven::read_spss() %>% 
  janitor::clean_names() %>% 
  mutate(support = as.factor(q5),
         date = chronicles_pvm8) %>% 
  select(support, date, wes_age_gender_tnp)
  
# Merge Chronicles data
chronicles_all <- rbind(chronicles_1, 
                        chronicles_2,
                        chronicles_3,
                        chronicles_4,
                        chronicles_5,
                        chronicles_6,
                        chronicles_7,
                        chronicles_8)

# Russian Field: define design
chronicles_all_design <- svydesign(ids =~ 1,
                           data = chronicles_all,
                           weights = chronicles_all$wes_age_gender_tnp)

# Russian Field: calculate percentages
chronicles_all <- svytable(~support + date, design = chronicles_all_design) %>% 
  as.data.frame() %>% 
  group_by(date) %>% 
  mutate(prc = round(100*Freq / sum(Freq), digits = 0)) %>% 
  filter(prc != 0)

chronicles_all$date <- factor(chronicles_all$date,
                        levels = c(chronicles_pvm1, 
                                   chronicles_pvm2,
                                   chronicles_pvm3,
                                   chronicles_pvm4,
                                   chronicles_pvm5,
                                   chronicles_pvm6,
                                   chronicles_pvm7,
                                   chronicles_pvm8))

chronicles_sotakannatus <-
  chronicles_all %>% 
  ggplot(aes(x = date, y = prc, fill = fct_rev(support))) +
  geom_col() +
  theme_oma() +
  geom_text(aes(label = paste0(prc,"%")),
            position = position_stack(vjust = 0.5),
            size = 4,
            fontface = "bold",
            family = "Times"
            ) +
  scale_fill_manual(values = c(kieltaytyy, eos, ehd_en_tue, tuen),
                    labels = rev(c("Tuen", "En tue", "En osaa sanoa", "Kieltäytyy vastaamasta"))) +
  theme(axis.text.y = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_text(angle = 30,
                                   size = 13),
        legend.title = element_text(face = "bold.italic",
                                    size = 14),
        legend.text = element_text(size = 12)
        ) +
  labs(fill = toupper("Sodan kannatus"),
       title = 'CHRONICLES: "Tuetteko Venäjän sotilasoperaatiota Ukrainan\nalueella, vai ettekö osaa sanoa tai halua vastata kysymykseen?"')

kuva_1 <- 
  (levada_sotakannatus | chronicles_sotakannatus) / (fom_sotakannatus | rf_sotakannatus) / vtsiom_sotakannatus_kuva

# kuva_1

# jpeg(here("img/kuva_1.jpg"), units = "in", width = 15, height = 12, res = 300)
# kuva_1
# dev.off()


```


```{r}
yandex_telegram <- here::here("data/yandex_telegram - Sheet1.csv") %>% 
  read.csv() %>% 
  janitor::clean_names() %>% 
  mutate(period = dmy(str_trim(str_replace_all(period, "\\-.*", ""))),
         relative = as.double(relative)) %>% 
  rename(date = period,
         absolute_telegram = absolute,
         relative_telegram = relative)

yandex_vpn <- here::here("data/yandex_vpn - Sheet1.csv") %>% 
  read.csv() %>% 
  janitor::clean_names() %>% 
  mutate(period = dmy(str_trim(str_replace_all(period, "\\-.*", ""))),
         relative = as.double(relative)) %>% 
  rename(date = period,
         absolute_vpn = absolute,
         relative_vpn = relative)

yandex_youtube <- here("data/yandex_youtube - Sheet1.csv") %>% 
  read.csv() %>% 
  janitor::clean_names() %>% 
  mutate(period = dmy(str_trim(str_replace_all(period, "\\-.*", ""))),
         relative = as.double(relative)) %>% 
  rename(date = period,
         absolute_youtube = absolute,
         relative_youtube = relative)

yandex_data <-
  yandex_telegram %>% 
  full_join(yandex_vpn) %>% 
  full_join(yandex_youtube) %>% 
  gather(key = "keyword_absolute", val = "absolute", absolute_telegram, absolute_vpn, absolute_youtube) %>% 
  # gather(key = "keyword_relative", val = "relative", relative_telegram, relative_vpn) %>% 
  select(date, keyword_absolute, absolute) %>% 
  mutate(keyword_absolute = recode(keyword_absolute, "absolute_telegram" = "telegram", "absolute_vpn" = "vpn", "absolute_youtube" = "youtube"))

hyokkays <- as.Date("2022-02-24")
viivanpaa <- as.Date("2021-10-01")

# Color palette for figure
youtube <- punainen
telegram <- "#355BB7"
vpn <- "#FDB409"

# Run the commented code below if you want month names in Finnish for the Yandex plots
# Sys.setlocale("LC_TIME", "fi_FI.UTF-8")

figure_yandex <-
  yandex_data %>% 
  ggplot(aes(x = date, y = absolute, color = keyword_absolute)) +
  geom_line(size = 1.5, alpha = 0.6) +
  theme_bw() +
  theme(text = element_text(family = "Times", face = "bold"),
        title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 12),
        legend.position = "bottom",
        # axis.line = element_line(arrow = arrow())
        axis.text.x = element_text(angle = 30,
                                   margin = margin(25, 25, 25, 25),
                                   size = 10),
        plot.margin = margin(0,1,0,0.5, "cm")
        ) +
  geom_vline(xintercept = hyokkays, linetype = "dashed") +
  geom_curve(aes(x = viivanpaa, y = 6000000, xend = hyokkays, yend = 8000000),
    data = yandex_data,
    arrow = arrow(length = unit(0.03, "npc")),
    curvature = -0.3,
    color = "black") +
  annotate("text", y = 5000000, x = viivanpaa, label = "Venäjän\nhyökkäyssota\nalkaa", size = 5) +
  # scale_x_date(date_labels = "%m", date_breaks = "1 month") +
  labs(title = '"telegram", "vpn" ja "youtube"',
       y = "Hakujen määrä (absoluuttinen)",
       x = "Päivämäärä (kk)",
       color = "Hakusana") +
  scale_color_manual(values = c(telegram, vpn, youtube),
                     labels = c('"телеграм"', '"vpn"', '"youtube"')) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_date(date_breaks = "1 month", date_labels = "%B")

yandex_soperation <- here::here("data/yandex_spetsoperatsiya - Sheet1.csv") %>% 
  read.csv() %>% 
  janitor::clean_names() %>% 
  mutate(period = dmy(str_trim(str_replace_all(period, "\\-.*", ""))),
         relative = as.double(relative)) %>% 
  rename(date = period,
         absolute_soperation = absolute,
         relative_soperation = relative)

yandex_voyna <- here::here("data/yandex_voyna - Sheet1.csv") %>% 
  read.csv() %>% 
  janitor::clean_names() %>% 
  mutate(period = dmy(str_trim(str_replace_all(period, "\\-.*", ""))),
         relative = as.double(relative)) %>% 
  rename(date = period,
         absolute_voyna = absolute,
         relative_voyna = relative)

yandex_data_war <- yandex_soperation %>% 
  full_join(yandex_voyna) %>% 
  gather(key = "keyword_absolute", val = "absolute", absolute_soperation, absolute_voyna) %>% 
  select(date, keyword_absolute, absolute) %>% 
  mutate(keyword_absolute = recode(keyword_absolute, "absolute_soperation" = 'Erikoisoperaatio ("спецоперация на украине")', "absolute_voyna" = 'Sota ("война на украине")'))

sota <- "#5FA137"
soperaatio <- "#949494"

figure_yandex_2 <-
  yandex_data_war %>% 
  ggplot(aes(x = date, y = absolute, color = keyword_absolute)) +
  geom_line(size = 1.5, alpha = 0.6) +
  theme_bw() +
  theme(text = element_text(family = "Times", face = "bold"),
        title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 12),
        legend.position = "bottom",
        axis.text.x = element_text(angle = 30,
                                   margin = margin(25, 25, 25, 25),
                                   size = 10),
        plot.margin = margin(0,1,0,0.5, "cm")) +
  geom_vline(xintercept = hyokkays, linetype = "dashed") +
  geom_curve(aes(x = viivanpaa, y = 6500000, xend = hyokkays, yend = 8000000),
    data = yandex_data,
    arrow = arrow(length = unit(0.03, "npc")),
    curvature = -0.3,
    color = "black") +
  annotate("text", y = 5500000, x = viivanpaa, label = "Venäjän\nhyökkäyssota\nalkaa", size = 5) +
  scale_x_date(date_breaks = "1 month", date_labels = "%B") +
  labs(title = '"erikoisoperaatio" vs. "sota"',
       y = NULL,
       x = "Päivämäärä (kk)",
       color = "Hakusana") +
  scale_y_continuous(labels = scales::comma) +
  scale_color_manual(values = c(soperaatio, sota),
                     labels = c('Erikoisoperaatio Ukrainassa\n("спецоперация на украине")', 'Sota Ukrainassa\n("война на украине")'))

# Put Yandex plots together
kuva_2 <- 
  figure_yandex + 
  figure_yandex_2 +
  plot_annotation(title = toupper('Tiedonvälitykseen ja sotaan liittyvien hakusanojen käyttö Yandexissa'), 
                  subtitle = "1.8.2020–31.7.2022") & theme(text = element_text(family = "Times", 
                                                                               size = 20,
                                                                               face = "bold"))

kuva_2

# jpeg(here("img/kuva_2.jpg"), units = "in", width = 17, height = 12, res = 300)
# kuva_2
# dev.off()

```

# Kuva 3

```{r}
rf_response_rates <-
  data.frame(
  pvm = as.character(c("26.–28.2.",
                     "5.–7.3.",
                     "13.–16.3.",
                     "23.–25.3.",
                     "13.–15.4.",
                     "2.–5.5.",
                     "23.–26.5.",
                     "28.–31.7.")),
  date = dmy(c("28.2.2022",
               "7.3.2022",
               "16.3.2022",
               "25.3.2022",
               "15.4.2022",
               "5.5.2022",
               "26.5.2022",
               "31.7.2022")),
  completed_n = as.integer(c(1997,
                1634,
                1651,
                1692,
                1628,
                1625,
                1602,
                1609)),
  refusal_n = as.integer(c(22303,
                         14862,
                         27862,
                         26761,
                         19500,
                         26517,
                         18886,
                         24538)),
  interrupted_n = as.integer(c(1343,
                             1331,
                             1801,
                             1494,
                             920,
                             1292,
                             1734,
                             1020)),
  completed_prc = as.double(c(0.0779,
                              0.0926,
                              0.0527,
                              0.056,
                              0.074,
                              0.055,
                              0.072,
                              0.059)),
  refusal_prc = as.double(c(0.87,
                            0.83,
                            0.89,
                            0.894,
                            0.885,
                            0.90,
                            0.85,
                            0.903)),
  interrupted_prc = as.double(c(0.05,
                                0.08,
                                0.06,
                                0.05,
                                0.042,
                                0.044,
                                0.078,
                                0.038))
)

# Save the data
# write.csv(rf_response_rates, here("data/rf_response_rates.csv"))

rf_rr_prc_df <-
  rf_response_rates %>% 
  pivot_longer(completed_prc:interrupted_prc,
               names_to = "response_category",
               values_to = "response_rate") %>%
    select(pvm, date, response_category, response_rate) %>% 
  mutate(response_rate = 100*round(response_rate, 2))

# Run the commented code below if you want month names in Finnish for the Yandex plots
# Sys.setlocale("LC_TIME", "fi_FI.UTF-8")

vihrea <- "#53A095"
punainen <- "#C75E51"
harmaa <- "#8C8C8C"

rr_p <- 
ggplot(rf_rr_prc_df) +
  aes(x = date, y = response_rate, fill = fct_rev(response_category)) +
  geom_col() +
  theme_oma() +
  geom_text(aes(label = paste0(response_rate, "%")),
            position = position_stack(vjust = 0.5),
            size = 6,
            fontface = "bold",
            family = "Times") +
    theme(
    axis.line.x = element_line(arrow = arrow()),
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    legend.position = "bottom",
    axis.title.x = element_text(face = "bold",
                                size = 18),
    plot.title = element_text(face = "bold.italic"),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 15)
  ) +
  scale_x_date(date_breaks = "1 month", date_labels = "%B") +
  labs(title = "Vastausprosentit",
       x = toupper("Kyselyn ajankohta (2022)"),
       fill = "KYSELYN TULOS") +
  geom_vline(xintercept = dmy("03-03-2022"), linetype = 2, size = 2, alpha = 0.5) +
  annotate("text", y = 103, x = dmy("08-04-2022"), label = "\"Valeuutislaki\" astuu voimaan", size = 6) +
  scale_fill_manual(values = c(punainen, harmaa, vihrea),
                    labels = c("Kieltäytyi", "Keskeytti", "Vastasi loppuun asti")) +
  geom_segment(aes(x = dmy("22-03-2022"), y = 103, xend = dmy("04-03-2022"), yend = 103),
                  arrow = arrow(length = unit(0.5, "cm")))

rf_rr_n_df <-
  rf_response_rates %>% 
  pivot_longer(completed_n:interrupted_n,
               names_to = "response_category",
               values_to = "response_rate") %>%
    select(pvm, date, response_category, response_rate)

rr_p_count <- 
ggplot(rf_rr_n_df) +
  aes(x = date, y = response_rate, fill = fct_rev(response_category)) +
  geom_col() +
  theme_oma() +
  geom_text(aes(label = paste0(response_rate)),
            position = position_stack(vjust = 0.5),
            size = 6,
            fontface = "bold",
            family = "Times") +
  theme(
    axis.line.x = element_line(arrow = arrow()),
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    legend.position = "bottom",
    axis.title.x = element_text(face = "bold",
                                size = 18),
    plot.title = element_text(face = "bold.italic"),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 15)
  ) +
  scale_x_date(date_breaks = "1 month", date_labels = "%B") +
  geom_vline(xintercept = dmy("03-03-2022"), linetype = 2, size = 2, alpha = 0.5) +
  annotate("text", y = 32000, x = dmy("08-04-2022"), label = "\"Valeuutislaki\" astuu voimaan", size = 6) +
  labs(title = "Yhteydenottojen määrä suhteessa vastauksiin",
       x = toupper("Kyselyn ajankohta (2022)"),
       fill = "KYSELYN TULOS") +
  scale_fill_manual(values = c(punainen, harmaa, vihrea),
                    labels = c("Kieltäytyi", "Keskeytti", "Vastasi loppuun asti")) +
  geom_segment(aes(x = dmy("22-03-2022"), y = 32000, xend = dmy("04-03-2022"), yend = 32000),
                  arrow = arrow(length = unit(0.5, "cm")))

kuva_3 <- 
rr_p / rr_p_count +
    plot_annotation(title = toupper("VASTAUSKATO HYÖKKÄYSSOTAAN LIITTYVISSÄ KYSELYISSÄ"), 
                  subtitle = "(Russian Field)") & theme(text = element_text(family = "Times", 
                                                                               size = 20,
                                                                               face = "bold"))

jpeg(here("img/kuva_3.jpg"), units = "in", width = 16, height = 14, res = 300)
kuva_3
dev.off()


```

# Kuva 4


```{r}
theme_oma2 <- function() {
  font <- "Times"
  theme_minimal() %+replace%
    theme(
      plot.title = element_text(
        family = font,
        size = 24,
        face = 'bold',
        hjust = 0,
        vjust = 2),
      plot.subtitle = element_text(
                   family = font,
                   face = 'bold',
                   size = 14),
      plot.caption = element_text(
        family = font,
        size = 14,
        face = 'bold',
        hjust = 1,
        colour = "black"),
      axis.title = element_text(
        family = font,
        size = 18),
      axis.text = element_text(
        family = font,
        face = 'bold',
        size = 14),
      axis.text.x = element_text(
        margin = margin(5, b = 10)),
      legend.title = element_text(
        family = font,
        size = 10,
        face = "bold"),
      legend.text = element_text(
        family = font,
        size = 8,
        face = "bold"),
      axis.title.x = element_text(
        face = "bold"
      )
    )
}



# Chronicles, Model 1: Import data
chronicles <- here::here("data/Полные Хроники 5.0.sav") %>% 
  haven::read_spss() %>% 
  janitor::clean_names() %>% 
  mutate(support = q21)

# Chronicles, Model 1: Subset the data
chronicles_model_1 <- chronicles %>% 
  select(support, age, gender, tnp, edu_gr, wes_age_gender_tnp) %>% 
  mutate(support = as.factor(
    case_when(support == 1 ~ 1, # tukee sotaa
              support == 2 ~ 0)), # ei tue
    gender = as.factor(
      case_when(gender == 2 ~ 0, # nainen
                gender == 1 ~ 1)), # mies
    tnp = as.factor(
      case_when(tnp == 2 ~ 0, # kylä
                tnp == 1 ~ 1)), # kaupunki
    edu_gr = as.factor(
      case_when(edu_gr == 2 ~ 1, # korkeakoulutus
                edu_gr == 1 ~ 0)), # ei korkeakoulutusta
    age = as.factor(
      case_when(
        between(age, 18, 29) ~ "18-29",
        between(age, 30, 44) ~ "30-44",
        between(age, 45, 59) ~ "45-59",
        age >= 60 ~ "60 ja yli")
    )
    ) %>% 
  drop_na()

# Chronicles, Model 1: define design
chronicles_model_1_design <- svydesign(ids =~ 1,
                                  data = chronicles_model_1,
                                  weights = chronicles_model_1$wes_age_gender_tnp)

# Chronicles, Model 1: run Model 1
chronicles_model_1 <- svyglm(formula = support ~ age + gender + tnp + edu_gr,
                        design = chronicles_model_1_design,
                        family = binomial(logit))

# Chronicles, Model 1: Check model summary
summary(chronicles_model_1)

# Chronicles, Model 1: Confidence intervals
chronicles_model_1_cis <- data.frame(confint(chronicles_model_1)) %>% 
  rename(lower_ci = 1,
         upper_ci = 2)
# Chronicles, Model 1: Calculate Odd Ratios
chronicles_model_1_or <- exp(cbind(coef(chronicles_model_1), confint(chronicles_model_1))) %>% 
  as.data.frame() %>% 
  rename(oratio = 1,
         oratio_lower = 2,
         oratio_upper = 3)
# Chronicles, Model 1: Merge data
chronicles_model_1_plot_data <- tidy(chronicles_model_1) %>% 
  cbind(chronicles_model_1_cis, chronicles_model_1_or) %>% 
  slice(-1)
# Chronicles, Model 1: Pseudo R^2: Cox-Snell & Nagelkerke
chronicles_model_1_coxsnell <- paste(round(100*psrsq(chronicles_model_1, method = "Cox-Snell"), digits = 1), "% (Cox-Snell)", sep = "")
chronicles_model_1_nagelkerke <- paste(round(100*psrsq(chronicles_model_1, method = "Nagelkerke"), digits = 1), "% (Nagelkerke)", sep = "")


vari_chronicles <- "#740002"

# Chronicles. Model 1: Odd ratios
kuva_4.1 <-
  chronicles_model_1_plot_data %>%
    ggplot(aes(x = term, y = oratio)) +
    geom_point(size = 6, color = vari_chronicles) +
    coord_flip() +
    geom_errorbar(aes(ymax = oratio_upper, ymin = oratio_lower), width = 0.2, color = "grey50") +
    theme_oma2() +
  scale_y_log10(breaks = seq(0,10,1)) +
  scale_x_discrete(labels = c("30–44-vuotiaat",
                              "45–59-vuotiaat ***", 
                              "60-vuotiaat ja vanhemmat ***", 
                              "Korkeakoulutus", 
                              "Sukupuoli: mies *", 
                              "Kaupunki **")) +
  theme(plot.title = element_text(color = vari_chronicles)) +
  geom_hline(yintercept = 1, linetype = 2) +
  labs(title = paste("CHRONICLES, Malli 1:", odds),
       # subtitle = odds,
       x = NULL,
       y = toupper("Riskiluku (logaritminen asteikko)"),
       caption = bquote(atop(paste(R^2, " = ", .(chronicles_model_1_coxsnell)), 
                             paste(R^2, " = ", .(chronicles_model_1_nagelkerke)))))

# Chronicles, Model 2: 
# Chronicles, Model 2: Subset data for Model 2
chronicles_model_2_data <- chronicles %>% 
  mutate(tutut_ihmiset = as.factor(q8_1),
         tv = as.factor(q8_2),
         youtube = as.factor(q8_5),
         en_seuraa = as.factor(q8_9),
         internet_sivut = as.factor(q8_8),
         telegram = as.factor(q8_6)) %>% 
  # Model 2 variables
  select(support, 
         age,
         gender,
         tnp,
         edu_gr,
         wes_age_gender_tnp,
         tutut_ihmiset,
         tv,
         youtube,
         en_seuraa,
         internet_sivut,
         telegram) %>% 
  mutate(support = as.factor(
    case_when(support == 1 ~ 1, # tukee sotaa
              support == 2 ~ 0)), # ei tue
    gender = as.factor(
      case_when(gender == 2 ~ 0, # nainen
                gender == 1 ~ 1)), # mies
    tnp = as.factor(
      case_when(tnp == 2 ~ 0, # kylä
                tnp == 1 ~ 1)), # kaupunki
    edu_gr = as.factor(
      case_when(edu_gr == 2 ~ 1, # korkeakoulutus
                edu_gr == 1 ~ 0)), # ei korkeakoulutusta
    age = as.factor(
      case_when(
        between(age, 18, 29) ~ "18-29",
        between(age, 30, 44) ~ "30-44",
        between(age, 45, 59) ~ "45-59",
        age >= 60 ~ "60 ja yli"))
    ) %>% 
  drop_na()

# Chronicles, Model 2: define design
chronicles_model_2_design <- svydesign(ids =~ 1,
                               data = chronicles_model_2_data,
                               weights = chronicles_model_2_data$wes_age_gender_tnp)

# Chronicles, Model 2: run the model
chronicles_model_2 <- svyglm(formula = support ~ age + gender + tnp + edu_gr + tutut_ihmiset + tv + youtube + en_seuraa + internet_sivut + telegram,
       design = chronicles_model_2_design,
       family = binomial(logit))
# Chronicles, Model 2: check the results
summary(chronicles_model_2)

# Chronicles, Model 2: Confidence intervals
chronicles_model_2_cis <- data.frame(confint(chronicles_model_2)) %>% 
  rename(lower_ci = 1,
         upper_ci = 2)
# Chronicles, Model 2: Calculate Odd Ratios
chronicles_model_2_or <- exp(cbind(coef(chronicles_model_2), confint(chronicles_model_2))) %>% 
  as.data.frame() %>% 
  rename(oratio = 1,
         oratio_lower = 2,
         oratio_upper = 3)
# Chronicles, Model 2: Merge data
chronicles_model_2_plot_data <- tidy(chronicles_model_2) %>% 
  cbind(chronicles_model_2_cis, chronicles_model_2_or) %>% 
  slice(-1)

# Chronicles, Model 2:  Pseudo R^2: Cox-Snell & Nagelkerke
chronicles_model_2_coxsnell <- paste(round(100*psrsq(chronicles_model_2, method = "Cox-Snell"), digits = 1), "% (Cox-Snell)", sep = "")
chronicles_model_2_nagelkerke <- paste(round(100*psrsq(chronicles_model_2, method = "Nagelkerke"), digits = 1), "% (Nagelkerke)", sep = "")

# Chronicles. Model 2: Odd ratios
kuva_4.2 <- 
  chronicles_model_2_plot_data %>%
    ggplot(aes(x = term, y = oratio)) +
    geom_point(size = 6, color = vari_chronicles) +
    coord_flip() +
    geom_errorbar(aes(ymax = oratio_upper, ymin = oratio_lower), width = 0.2, color = "grey50") +
    theme_oma2() +
  scale_y_log10(breaks = seq(0,9,1)) +
  scale_x_discrete(labels = c("30–44-vuotiaat",
                              "45–59-vuotiaat *",
                              "60-vuotiaat ja vanhemmat",
                              "Korkeakoulutus",
                              "Tiedonlähde: Ei seuraa tapahtumia",
                              "Sukupuoli",
                              "Tiedonlähde: Internet-sivut",
                              "Tiedonlähde: Telegram",
                              "Kaupunki *",
                              "Tiedonlähde: Tutut ihmiset *",
                              "Tiedonlähde: TV ***",
                              "Tiedonlähde: YouTube ***")) +
  theme(plot.title = element_text(color = vari_chronicles)) +
  geom_hline(yintercept = 1, linetype = 2) +
  labs(title = paste("CHRONICLES, Malli 2:", odds),
       x = NULL,
       y = toupper("Riskiluku (logaritminen asteikko)"),
       caption = bquote(atop(paste(R^2, " = ", .(chronicles_model_2_coxsnell)), 
                             paste(R^2, " = ", .(chronicles_model_2_nagelkerke)))))

# Chronicles. Model 3: Define variables
chronicles <- chronicles %>% 
  mutate(tutut_ihmiset = as.factor(q8_1),
         tv = as.factor(q8_2),
         youtube = as.factor(q8_5),
         en_seuraa = as.factor(q8_9),
         internet_sivut = as.factor(q8_8),
         telegram = as.factor(q8_6),
         perhe_tulot = as.factor(q4_2),
         maan_asiat = as.factor(q9),
         sukul_osallist = as.factor(q6),
         perhe_mat_tilanne = as.factor(q10),
         tyo_lomautus = q4_1,
         perhe_varautuminen = q4_3)

# Chronicles, Model 3: Subset the data
chronicles_model_3_data <- chronicles %>% 
  select(support, age, gender, tnp, edu_gr, wes_age_gender_tnp, tutut_ihmiset, tv, youtube, en_seuraa, internet_sivut, telegram, perhe_tulot, maan_asiat, sukul_osallist, perhe_mat_tilanne, tyo_lomautus, perhe_varautuminen) %>% 
  mutate(support = as.factor(
    case_when(support == 1 ~ 1, # tukee sotaa
              support == 2 ~ 0)), # ei tue
    gender = as.factor(
      case_when(gender == 2 ~ 0, # nainen
                gender == 1 ~ 1)), # mies
    tnp = as.factor(
      case_when(tnp == 2 ~ 0, # kylä
                tnp == 1 ~ 1)), # kaupunki
    edu_gr = as.factor(
      case_when(edu_gr == 2 ~ 1, # korkeakoulutus
                edu_gr == 1 ~ 0)),
    perhe_tulot = as.factor(
        case_when(perhe_tulot == 1 ~ 2, # tulot pienentyneet
                  perhe_tulot == 2 ~ 1)), # tulot eivät pienentyneet
    maan_asiat = as.factor(
      case_when(maan_asiat == 4 ~ 1, # ehdottomasti oikeaan suuntaan
                maan_asiat == 3 ~ 2, # ennemmin oikeaan suuntaan
                maan_asiat == 2 ~ 3, # ennemmin väärään suuntaan
                maan_asiat == 1 ~ 4)), # ehdottomasti väärään suuntaan
    sukul_osallist = as.factor(
      case_when(sukul_osallist == 1 ~ 2, # osallistunut
                sukul_osallist == 2 ~ 1)), # ei osallistunut
    age = as.factor(
      case_when(
        between(age, 18, 29) ~ "18-29",
        between(age, 30, 44) ~ "30-44",
        between(age, 45, 59) ~ "45-59",
        age >= 60 ~ "60 ja yli")),
    tyo_lomautus = as.factor(
        case_when(tyo_lomautus == 1 ~ 2, # lomautettu töistä
                  tyo_lomautus == 2 ~ 1)),
    perhe_varautuminen = as.factor(
        case_when(perhe_varautuminen == 1 ~ 2, # perhe varautunut materiaalisesti: kyllä
                  perhe_varautuminen == 2 ~ 1))) %>% 
  drop_na()

# Chronicles. Model 3: define design
chronicles_model_3_design <- svydesign(ids =~ 1,
                                  data = chronicles_model_3_data,
                                  weights = chronicles_model_3_data$wes_age_gender_tnp)
# Chronicles. Model 3: run the model
chronicles_model_3 <- svyglm(formula = support ~ age + gender + tnp + edu_gr + tutut_ihmiset + tv + youtube + en_seuraa + internet_sivut + telegram + perhe_tulot + sukul_osallist + tyo_lomautus + perhe_varautuminen,
       design = chronicles_model_3_design,
       family = binomial(logit))
# Chronicles. Model 3: print the results
summary(chronicles_model_3)

# Chronicles. Model 3: Confidence intervals
chronicles_model_3_cis <- data.frame(confint(chronicles_model_3)) %>% 
  rename(lower_ci = 1,
         upper_ci = 2)

# Chronicles. Model 3: Calculate Odd Ratios
chronicles_model_3_or <- exp(cbind(coef(chronicles_model_3), confint(chronicles_model_3))) %>% 
  as.data.frame() %>% 
  rename(oratio = 1,
         oratio_lower = 2,
         oratio_upper = 3)

# Chronicles. Model 3: plot data
chronicles_model_3_plot_data <- tidy(chronicles_model_3) %>% 
  cbind(chronicles_model_3_cis, chronicles_model_3_or) %>% 
  slice(-1) %>%
  mutate(term = as.factor(term))

# Chronicles. Model 3: Pseudo R^2: Cox-Snell & Nagelkerke
chronicles_model_3_coxsnell <- paste(round(100*psrsq(chronicles_model_3, method = "Cox-Snell"), digits = 1), "% (Cox-Snell)", sep = "")
chronicles_model_3_nagelkerke <- paste(round(100*psrsq(chronicles_model_3, method = "Nagelkerke"), digits = 1), "% (Nagelkerke)", sep = "")

# Chronicles, Model 3: Odd ratios plot
kuva_4.3 <- 
  chronicles_model_3_plot_data %>% 
  ggplot(aes(x = term, y = oratio)) +
  geom_point(size = 6, color = vari_chronicles) +
  coord_flip() +
  scale_y_log10(breaks = seq(0,11,1)) +
  geom_errorbar(aes(ymax = oratio_upper, ymin = oratio_lower), width = 0.2, color = "grey50") +
  theme_oma2() +
  theme(plot.title = element_text(color = vari_chronicles)) +
  geom_hline(yintercept = 1, linetype = 2) +
  labs(title = paste("CHRONICLES, Malli 3:", odds),
       x = NULL,
       y = toupper("Riskiluku (logaritminen asteikko)"),
       caption = bquote(atop(paste(R^2, " = ", .(chronicles_model_3_coxsnell)), 
                             paste(R^2, " = ", .(chronicles_model_3_nagelkerke))))) +
       scale_x_discrete(labels = c("30–44-vuotiaat",
                              "45–59-vuotiaat *",
                              "60-vuotiaat ja vanhemmat",
                              "Korkeakoulutus",
                              "Tiedonlähde: Ei seuraa tapahtumia",
                              "Sukupuoli: mies",
                              "Tiedonlähde: Internet-sivut",
                              "Perheen tulot vähentyneet ***",
                              "Perhe ostanut ruokaa ja päivittäistarpeita varalle **",
                              "Sukulaisia tai perheenjäseniä osallistunut sotaan",
                              "Tiedonlähde: Telegram",
                              "Kaupunki *",
                              "Tiedonlähde: Tutut ihmiset **",
                              "Tiedonlähde: TV ***",
                              "Irtisanottu töistä **",
                              "Tiedonlähde: YouTube ***"))
  
kuva_4 <- 
  kuva_4.1 /
  kuva_4.2 /
  kuva_4.3

jpeg(here("img/kuva_4.jpg"), units = "in", width = 16, height = 18, res = 300)
kuva_4
dev.off()

```

# Kuva 5

```{r}
# Russian Field, Model 1: import the data
rf <- here::here("data/МАССИВ SPSS Russian Field - _Россия-Украина_ (всероссийский телефонный опрос, 1600, 5-7 марта).sav") %>% 
  haven::read_spss() %>% 
  janitor::clean_names() %>% 
  mutate(support = q5,
         ika = q3,
         sukupuoli = q2,
         tv = as.factor(q8_1),
         valt_printtimedia = as.factor(q8_2),
         valt_media_nettisivut = as.factor(q8_3),
         radio = as.factor(q8_4),
         sanomalehdet = as.factor(q8_5),
         valt_nettisivut = as.factor(q8_6),
         vkontakte = as.factor(q8_7),
         odnoklassiki = as.factor(q8_8),
         facebook = as.factor(q8_9),
         instagram = as.factor(q8_10),
         twitter = as.factor(q8_11),
         yandex_google = as.factor(q8_12),
         youtube = as.factor(q8_13),
         telegram = as.factor(q8_14),
         whatsapp = as.factor(q8_15),
         viber = as.factor(q8_16),
         tutut = as.factor(q8_17),
         muut = as.factor(q8_18),
         en_seuraa = as.factor(q8_19))

# Russian Field, Model 1: subset the data
rf_model_1_data <- rf %>% 
  select(support:en_seuraa, vtpv) %>% 
  mutate(
  support = as.factor(
    case_when(support %in% c(1, 2) ~ 1,
              support %in% c(3, 4) ~ 0)),
  sukupuoli = as.factor(
    case_when(sukupuoli == 1 ~ 1, # mies
              sukupuoli == 2 ~ 0)), # nainen
  ika = as.factor(ika)) %>% 
  drop_na()

# Russian Field, Model 1: define weights
rf_model_1_design <- svydesign(ids =~ 1,
                               data = rf_model_1_data,
                               weights = rf_model_1_data$vtpv)

# Russian Field, Model 1: run the model
rf_model_1 <- svyglm(support ~ ika + sukupuoli + tv + youtube + telegram + tutut + yandex_google + valt_nettisivut + valt_media_nettisivut + vkontakte,
       design = rf_model_1_design,
       family = binomial(logit))

# Russian Field, Model 1: print the results
summary(rf_model_1)

# Russian Field, Model 1:  Confidence intervals
rf_model_1_cis <- data.frame(confint(rf_model_1)) %>% 
  rename(lower_ci = 1,
         upper_ci = 2)
# Russian Field, Model 1:  Calculate Odd Ratios
rf_model_1_or <- exp(cbind(coef(rf_model_1), confint(rf_model_1))) %>% 
  as.data.frame() %>% 
  rename(oratio = 1,
         oratio_lower = 2,
         oratio_upper = 3)

# Russian Field, Model 1: data for plot
rf_model_1_plot_data <- tidy(rf_model_1) %>% 
  cbind(rf_model_1_cis, rf_model_1_or) %>% 
  slice(-1) %>%
  mutate(term = as.factor(term))

# Russian Field, Model 1:  Pseudo R^2: Cox-Snell & Nagelkerke
rf_model_1_coxsnell <- paste(round(100*psrsq(rf_model_1, method = "Cox-Snell"), digits = 1), "% (Cox-Snell)", sep = "")
rf_model_1_nagelkerke <- paste(round(100*psrsq(rf_model_1, method = "Nagelkerke"), digits = 1), "% (Nagelkerke)", sep = "")
# Russian Field, Model 1: plot X-axis labels
rf_model_1_labels <- c("30–44-vuotiaat **",
                       "45–59-vuotiaat ***",
                       "60-vuotiaat ja vanhemmat",
                       "Sukupuoli: mies *",
                       "Tiedonlähde: Telegram",
                       "Tiedonlähde: Tutut ihmiset",
                       "Tiedonlähde: TV ***",
                       "Tiedonlähde: Valtionmedian nettisivut *",
                       "Tiedonlähde: Valtioelinten nettisivut *",
                       "Tiedonlähde: VKontakte",
                       "Tiedonlähde: Yandex tai Google",
                       "Tiedonlähde: YouTube ***")
# Russian Field, Model 1:  Regression coefficients plot
rf_model_1_coefs_plot <-
  rf_model_1_plot_data %>% 
  ggplot(aes(x = term, y = estimate)) +
  geom_point(size = 3.5) +
  coord_flip() +
  ylim(-1.5, 1.5) +
  geom_errorbar(aes(ymax = upper_ci, ymin = lower_ci), width = 0.2, color = "grey50") +
  theme_bw() +
  theme(text = element_text(family = "Times",
                            face = "bold",
                            size = 14)) +
  geom_hline(yintercept = 0, linetype = 2) +
  labs(title = "Russian Field: Malli 1 ",
       subtitle = coefs,
       x = NULL,
       y = "Regressiokerroin") +
    scale_x_discrete(labels = rf_model_1_labels)

vari_rf <- "#1189E6"
  
# Russian Field, Model 1: Odd ratios plot
kuva_5.1 <- 
  rf_model_1_plot_data %>% 
  ggplot(aes(x = term, y = oratio)) +
  geom_point(size = 6, color = vari_rf) +
  coord_flip() +
  scale_y_log10(breaks = seq(0, 4, 1)) +
  geom_errorbar(aes(ymax = oratio_upper, ymin = oratio_lower), width = 0.2, color = "grey50") +
  theme_oma2() +
  theme(plot.title = element_text(color = vari_rf)) +
  geom_hline(yintercept = 1, linetype = 2) +
  labs(title = paste("RUSSIAN FIELD, Malli 1:", odds),
       x = NULL,
       y = toupper("Riskiluku (logaritminen asteikko)"),
       caption = bquote(atop(paste(R^2, " = ", .(rf_model_1_coxsnell)), 
                             paste(R^2, " = ", .(rf_model_1_nagelkerke))))) +
  scale_x_discrete(labels = rf_model_1_labels)

  
# Russian Field, Model 2:  
rf_model_2_data <- rf %>% 
  mutate(
  support = as.factor(
    case_when(support %in% c(1, 2) ~ 1,
              support %in% c(3, 4) ~ 0)),
  sukupuoli = as.factor(
    case_when(sukupuoli == 1 ~ 1, # mies
              sukupuoli == 2 ~ 0)), # nainen
  ika = as.factor(ika),
  sanktio_henk_koht = as.factor(q9_1),
  sanktio_perhe = as.factor(q9_2),
  sanktio_ystavat = as.factor(q9_3),
  sanktio_ei_vaikutusta = as.factor(q9_4),
  talous_nakyma = as.factor(
    case_when(q11 == 1 ~ 4, # tulot lisääntyvät
              q11 == 2 ~ 3, # tulot pysyvät ennallaan
              q11 == 3 ~ 2, # tulot pienentyvät merkittävästi
              q11 == 4 ~ 1)), # menetän tulonlähteeni
  talous_tilanne = as.factor(
    case_when(q12 == 1 ~ 1, # rahat eivät riitä elintarvikkeisiin
              q12 == 2 ~ 2, # rahat riittävät vaivoin vaatteisiin
              q12 == 3 ~ 3, # rahat riittävät ruokaan ja vaatteisiin, mutta vaivoin kodinkoneisiin
              q12 == 4 ~ 4, # rahat riittävät kodinkoneisiin, mutta ei muuhun
              q12 == 5 ~ 5)) # rahat riittävät käytännössä kaikkeen
  ) %>% 
  select(support:talous_tilanne, vtpv) %>% 
  drop_na()

# Russian Field, Model 2:  define weights
rf_model_2_design <- svydesign(ids =~ 1,
                               data = rf_model_2_data,
                               weights = rf_model_2_data$vtpv)

# Russian Field, Model 2:  run the model
rf_model_2 <- svyglm(support ~ ika + sukupuoli + tv + youtube + telegram + tutut + yandex_google + valt_nettisivut + valt_media_nettisivut + vkontakte + sanktio_henk_koht + sanktio_ystavat + sanktio_perhe + sanktio_ei_vaikutusta,
       design = rf_model_2_design,
       family = binomial(logit))
# Russian Field, Model 2: print the results
summary(rf_model_2)

# Russian Field, Model 2: Confidence intervals
rf_model_2_cis <- data.frame(confint(rf_model_2)) %>% 
  rename(lower_ci = 1,
         upper_ci = 2)
# Russian Field, Model 2: Calculate Odd Ratios
rf_model_2_or <- exp(cbind(coef(rf_model_2), confint(rf_model_2))) %>% 
  as.data.frame() %>% 
  rename(oratio = 1,
         oratio_lower = 2,
         oratio_upper = 3)

# Russian Field, Model 2: data for plot
rf_model_2_plot_data <- tidy(rf_model_2) %>% 
  cbind(rf_model_2_cis, rf_model_2_or) %>% 
  slice(-1) %>%
  mutate(term = as.factor(term))

# Russian Field, Model 2:  Pseudo R^2: Cox-Snell & Nagelkerke
rf_model_2_coxsnell <- paste(round(100*psrsq(rf_model_2, method = "Cox-Snell"), digits = 1), "% (Cox-Snell)", sep = "")
rf_model_2_nagelkerke <- paste(round(100*psrsq(rf_model_2, method = "Nagelkerke"), digits = 1), "% (Nagelkerke)", sep = "")
# Russian Field, Model 2: X-axis labels
rf_model_2_labels <- c("30–44-vuotiaat **",
                       "45–59-vuotiaat **",
                       "60-vuotiaat ja vanhemmat",
                       "Sanktiot: ei vaikutusta *",
                       "Sanktiot: vaikuttaneet henkilökohtaisesti **",
                       "Sanktiot: vaikuttaneet perheeseen",
                       "Sanktiot: vaikuttaneet ystäviin",
                       "Sukupuoli: mies *",
                       "Tiedonlähde: Telegram",
                       "Tiedonlähde: tutut ihmiset",
                       "Tiedonlähde: TV ***",
                       "Tiedonlähde: Valtionmedian nettisivut *",
                       "Tiedonlähde: Valtioelinten nettisivut **",
                       "Tiedonlähde: VKontakte",
                       "Tiedonlähde: Yandex tai Google",
                       "Tiedonlähde: YouTube **")
# Russian Field, Model 2: Regression coefficients plot
rf_model_2_coefs_plot <-
  rf_model_2_plot_data %>% 
  ggplot(aes(x = term, y = estimate)) +
  geom_point(size = 3.5) +
  coord_flip() +
  ylim(-1.5, 1.5) +
  geom_errorbar(aes(ymax = upper_ci, ymin = lower_ci), width = 0.2, color = "grey50") +
  theme_bw() +
  theme(text = element_text(family = "Times",
                            face = "bold",
                            size = 14)) +
  geom_hline(yintercept = 0, linetype = 2) +
  labs(title = "Russian Field: Malli 2 ",
       subtitle = coefs,
       x = NULL,
       y = "Regressiokerroin") +
    scale_x_discrete(labels = rf_model_2_labels)

# Russian Field, Model 2: Odd ratios plot
kuva_5.2 <-
rf_model_2_plot_data %>% 
  ggplot(aes(x = term, y = oratio)) +
  geom_point(size = 6, color = vari_rf) +
  coord_flip() +
  scale_y_log10(breaks = seq(1, 80, 1)) +
  geom_errorbar(aes(ymax = oratio_upper, ymin = oratio_lower), width = 0.2, color = "grey50") +
  theme_oma2() +
  theme(plot.title = element_text(color = vari_rf)) +
  geom_hline(yintercept = 1, linetype = 2) +
  labs(title = paste("RUSSIAN FIELD, Malli 2:", odds),
       x = NULL,
       y = toupper("Riskiluku (logaritminen asteikko)"),
       caption = bquote(atop(paste(R^2, " = ", .(rf_model_2_coxsnell)),
                      paste(R^2, " = ", .(rf_model_2_nagelkerke))))) +
  scale_x_discrete(labels = rf_model_2_labels)

kuva_5 <- 
  kuva_5.1 /
  kuva_5.2

jpeg(here("img/kuva_5.jpg"), units = "in", width = 16, height = 18, res = 300)
kuva_5
dev.off()


```

# Kuva 6


```{r}
# February 1
vtsiom_1 <- here("data/База_Спецоперация (25.02).sav") %>% 
  read_spss() %>% 
  clean_names()
# February 2
vtsiom_2 <- here("data/База_Спецоперация (27.02).sav") %>% 
  read_spss() %>% 
  clean_names()
# March 1
vtsiom_3 <- here("data/ § _‘‚ (17.03).sav") %>% 
  read_spss() %>% 
  clean_names()
# March 2
vtsiom_4 <- here("data/ § _‘‚ (24.03)  3.sav") %>% 
  read_spss() %>% 
  clean_names()
# May
vtsiom_5 <- here("data/База_СВО++ (26.05.2022).sav") %>% 
  read_spss() %>% 
  clean_names()
# June
vtsiom_6 <- here("data/База СВО (25.06.2022).sav") %>% 
  haven::read_spss() %>% 
  clean_names()

# VTSIOM, Model 1: Subset the datasets for Model 1
vtsiom_1_model_1 <- vtsiom_1 %>%
  select(vo4, sex, age, edu, tip, weight1) %>% 
  rename(support = vo4)

vtsiom_2_model_1 <- vtsiom_2 %>%
  select(vo4, sex, age, edu, tip, weight1) %>% 
  rename(support = vo4)

vtsiom_3_model_1 <- vtsiom_3 %>%
  select(q2, sex, age, edu, tip, weight1) %>% 
  rename(support = q2)

vtsiom_4_model_1 <- vtsiom_4 %>%
  select(q1, sex, age, edu, tip, weight1) %>% 
  rename(support = q1)

vtsiom_5_model_1 <- vtsiom_5 %>%
  select(vo4, sex, age, edu, tip, weight1) %>% 
  rename(support = vo4)

vtsiom_6_model_1 <- vtsiom_6 %>%
  select(vo4, sex, age, edu, tip, weight1) %>% 
  rename(support = vo4)

# VTSIOM, Model 1: Merge data
vtsiom_model_1_data <- rbind(vtsiom_1_model_1, 
                             vtsiom_2_model_1,
                             vtsiom_3_model_1,
                             vtsiom_4_model_1,
                             vtsiom_5_model_1,
                             vtsiom_6_model_1)

# VTSIOM, Model 1: recode variables
vtsiom_model_1_data <- vtsiom_model_1_data %>% 
  mutate(
    ika = as.factor(
      case_when(
        between(age, 18, 29) ~ "18-29",
        between(age, 30, 44) ~ "30-44",
        between(age, 45, 59) ~ "45-59",
        age >= 60 ~ "60 ja yli")),
    support = as.factor(
      case_when(
        support == 1 ~ 1, # tukee
        support == 2 ~ 0)), # ei tue
    sukupuoli = as.factor(
      case_when(
        sex == 1 ~ 1, # mies
        sex == 2 ~ 0)), # nainen
    koulutus = as.factor(
      case_when(
        edu %in% c(5, 6) ~ 1, # korkeakoulutettu
        edu %in% c(1, 2, 3, 4) ~ 0)), # ei korkeakoulutettu
    asuinpaikka = as.factor(
      case_when(tip == 1 ~ 7, # Miljoonakaupunki
                tip == 2 ~ 6, # 500,000-950,000 asukasta
                tip == 3 ~ 5, # 100,000-500,000 asukasta
                tip == 4 ~ 4, # 50,000-100,000 asukasta
                tip == 5 ~ 3, # alle 50,000 asukasta
                tip == 6 ~ 2, # kaupungin tapainen taajama
                tip == 7 ~ 1)) # kylä
    ) %>% 
  select(support, ika, sukupuoli, asuinpaikka, koulutus, weight1) %>% 
  drop_na()
# VTSIOM, Model 1: define design
vtsiom_model_1_design <- svydesign(ids =~ 1,
                                   data = vtsiom_model_1_data,
                                   weights = vtsiom_model_1_data$weight1)
# VTSIOM, Model 1: run the model
vtsiom_model_1 <- svyglm(support ~ ika + sukupuoli + asuinpaikka + koulutus,
                         design = vtsiom_model_1_design,
                         family = binomial(logit))
# VTSIOM, Model 1: print the results
summary(vtsiom_model_1)

# VTSIOM, Model 1:  Confidence intervals
vtsiom_model_1_cis <- data.frame(confint(vtsiom_model_1)) %>% 
  rename(lower_ci = 1,
         upper_ci = 2)
# VTSIOM, Model 1:  Calculate Odd Ratios
vtsiom_model_1_or <- exp(cbind(coef(vtsiom_model_1), confint(vtsiom_model_1))) %>% 
  as.data.frame() %>% 
  rename(oratio = 1,
         oratio_lower = 2,
         oratio_upper = 3)
# VTSIOM, Model 1: data for plot
vtsiom_model_1_plot_data <- tidy(vtsiom_model_1) %>% 
  cbind(vtsiom_model_1_cis, vtsiom_model_1_or) %>% 
  slice(-1) %>%
  mutate(term = as.factor(term))

# VTSIOM, Model 1:  Pseudo R^2: Cox-Snell & Nagelkerke
vtsiom_model_1_coxsnell <- paste(round(100*psrsq(vtsiom_model_1, method = "Cox-Snell"), digits = 1), "% (Cox-Snell)", sep = "")
vtsiom_model_1_nagelkerke <- paste(round(100*psrsq(vtsiom_model_1, method = "Nagelkerke"), digits = 1), "% (Nagelkerke)", sep = "")

# VTSIOM, Model 1: plot labels
vtsiom_model_1_labels <- c("Kaupungin tapainen taajama",
                           "Alle 50,000 asukkaan kaupunki *",
                           "50,000–100,000 asukkaan kaupunki",
                           "100,000–500,000 asukkaan kaupunki ***",
                           "500,000–950,000 asukkaan kaupunki ***",
                           "Miljoonakaupunki ***",
                           "30–44-vuotiaat ***",
                           "45–59-vuotiaat ***",
                           "60-vuotiaat ja vanhemmat ***",
                           "Korkeakoulutettu ***",
                           "Sukupuoli: mies **")
# VTSIOM, Model 1: regression coefficients plot
vtsiom_model_1_coefs_plot <- 
  vtsiom_model_1_plot_data %>% 
  ggplot(aes(x = term, y = estimate)) +
  geom_point(size = 3.5) +
  coord_flip() +
  ylim(-2.5, 2.5) +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2, color = "grey50") +
  theme_bw() +
  theme(text = element_text(family = "Times",
                            face = "bold",
                            size = 14)) +
  geom_hline(yintercept = 0, linetype = 2) +
  labs(title = "VTsIOM: Malli 1",
       subtitle = coefs,
       x = NULL,
       y = "Regressiokerroin") +
  scale_x_discrete(labels = vtsiom_model_1_labels)

# VTSIOM, Model 1: Odd ratios plot
vtsiom_model_1_ors_plot <-
  vtsiom_model_1_plot_data %>% 
  ggplot(aes(x = term, y = oratio)) +
  geom_point(size = 3.5) +
  coord_flip() +
  scale_y_log10(breaks = seq(0, 10, 1)) +
  geom_errorbar(aes(ymin = oratio_lower, ymax = oratio_upper), width = 0.2, color = "grey50") +
  theme_bw() +
  theme(text = element_text(family = "Times",
                            face = "bold",
                            size = 14)) +
  geom_hline(yintercept = 1, linetype = 2) +
  labs(title = NULL,
       subtitle = odds,
       x = NULL,
       y = "Riskiluku (logaritminen asteikko)",
       caption = bquote(atop(paste(R^2, " = ", .(vtsiom_model_1_coxsnell)),
                             paste(R^2, " = ", .(vtsiom_model_1_nagelkerke))))) +
  scale_x_discrete(labels = NULL)

# VTSIOM, Model 1: combine coeffients and odd ratios plots
vtsiom_model_1_plot <- vtsiom_model_1_coefs_plot + vtsiom_model_1_ors_plot
# VTSIOM, Model 1: print the model plot
vtsiom_model_1_plot

# VTSIOM, Model 2: Subset the datasets for Model 2
vtsiom_1_model_2 <- vtsiom_1 %>%
  select(vo4, sex, age, edu, tip, tv, d1, dohod_0, weight1) %>% 
  rename(support = vo4,
         internet_kaytto = d1,
         perhe_tulot = dohod_0)

vtsiom_2_model_2 <- vtsiom_2 %>%
  select(vo4, sex, age, edu, tip, tv, d1, dohod_0, weight1) %>% 
  rename(support = vo4,
         internet_kaytto = d1,
         perhe_tulot = dohod_0)

vtsiom_3_model_2 <- vtsiom_3 %>%
  select(q2, sex, age, edu, tip, tv, d1, dohod_0, weight1) %>% 
  rename(support = q2,
         internet_kaytto = d1,
         perhe_tulot = dohod_0)

vtsiom_4_model_2 <- vtsiom_4 %>%
  select(q1, sex, age, edu, tip, tv, d1, dohod_0, weight1) %>% 
  rename(support = q1,
         internet_kaytto = d1,
         perhe_tulot = dohod_0)

vtsiom_5_model_2 <- vtsiom_5 %>%
  select(vo4, sex, age, edu, tip, tv, d1, dohod_0, weight1) %>% 
  rename(support = vo4,
         internet_kaytto = d1,
         perhe_tulot = dohod_0)

vtsiom_6_model_2 <- vtsiom_6 %>%
  select(vo4, sex, age, edu, tip, tv, d1, dohod_0, weight1) %>% 
  rename(support = vo4,
         internet_kaytto = d1,
         perhe_tulot = dohod_0)

# VTSIOM, Model 2: Merge datasets
vtsiom_model_2_data <- rbind(vtsiom_1_model_2, 
                             vtsiom_2_model_2,
                             vtsiom_3_model_2,
                             vtsiom_4_model_2,
                             vtsiom_5_model_2,
                             vtsiom_6_model_2)
# VTSIOM, Model 2: data tranform
vtsiom_model_2_data <-
  vtsiom_model_2_data %>% 
  mutate(
    ika = as.factor(
      case_when(
        between(age, 18, 29) ~ "18-29",
        between(age, 30, 44) ~ "30-44",
        between(age, 45, 59) ~ "45-59",
        age >= 60 ~ "60 ja yli")),
    support = as.factor(
      case_when(
        support == 1 ~ 1, # tukee
        support == 2 ~ 0)), # ei tue
    sukupuoli = as.factor(
      case_when(
        sex == 1 ~ 1, # mies
        sex == 2 ~ 0)), # nainen
    koulutus = as.factor(
      case_when(
        edu %in% c(5, 6) ~ 1, # korkeakoulutettu
        edu %in% c(1, 2, 3, 4) ~ 0)), # ei korkeakoulutettu
    asuinpaikka = as.factor(
      case_when(tip == 1 ~ 7, # Miljoonakaupunki
                tip == 2 ~ 6, # 500,000-950,000 asukasta
                tip == 3 ~ 5, # 100,000-500,000 asukasta
                tip == 4 ~ 4, # 50,000-100,000 asukasta
                tip == 5 ~ 3, # alle 50,000 asukasta
                tip == 6 ~ 2, # kaupungin tapainen taajama
                tip == 7 ~ 1)), # kylä
    tv = as.factor(
      case_when(tv == 1 ~ 6, # päivittäin yli 4 tuntia
                tv == 2 ~ 5, # päivittäin alle 4 tuntia
                tv == 3 ~ 4, # pari kertaa viikossa
                tv == 4 ~ 3, # pari kertaa kuukaudessa
                tv == 5 ~ 2, # harvoin, mutta useammin kuin kerran puolessa vuodessa
                tv == 6 ~ 1)), # en katso TV:tä
    internet_kaytto = as.factor(
      case_when(internet_kaytto == 1 ~ 6, # päivittäin yli 4h 
                internet_kaytto == 2 ~ 5, # päivittäin alle 4h
                internet_kaytto == 3 ~ 4, # pari kertaa viikossa
                internet_kaytto == 4 ~ 3, # pari kertaa kuukaudessa
                internet_kaytto == 5 ~ 2, # harvoin, mutta 
                internet_kaytto == 96 ~ 1)), # en käytä nettiä
    perhe_tulot = as.factor(
      case_when(perhe_tulot == 1 ~ 5, # todella hyvä
                perhe_tulot == 2 ~ 4, # hyvä
                perhe_tulot == 3 ~ 3, # keskinkertainen
                perhe_tulot == 4 ~ 2, # huono
                perhe_tulot == 5 ~ 1)) # todella huono
  ) %>% 
    select(support, ika, sukupuoli, koulutus, asuinpaikka, tv, internet_kaytto, perhe_tulot, weight1) %>% 
    drop_na()

# VTSIOM, Model 2: Define weights
vtsiom_model_2_design <- svydesign(ids =~ 1,
                                   data = vtsiom_model_2_data,
                                   weights = vtsiom_model_2_data$weight1)

# VTSIOM, Model 2: Define model
vtsiom_model_2 <- svyglm(support ~ ika + sukupuoli + koulutus + asuinpaikka + tv + internet_kaytto + perhe_tulot,
                         design = vtsiom_model_2_design,
                         family = binomial(logit))
# VTSIOM, Model 2: print the results
summary(vtsiom_model_2)

# VTSIOM, Model 2: Confidence intervals
vtsiom_model_2_cis <- data.frame(confint(vtsiom_model_2)) %>% 
  rename(lower_ci = 1,
         upper_ci = 2)
# VTSIOM, Model 2: Calculate Odd Ratios
vtsiom_model_2_or <- exp(cbind(coef(vtsiom_model_2), confint(vtsiom_model_2))) %>% 
  as.data.frame() %>% 
  rename(oratio = 1,
         oratio_lower = 2,
         oratio_upper = 3)

# VTSIOM, Model 2: data for plot
vtsiom_model_2_plot_data <- tidy(vtsiom_model_2) %>% 
  cbind(vtsiom_model_2_cis, vtsiom_model_2_or) %>% 
  slice(-1) %>%
  mutate(term = as.factor(term))

# VTSIOM, Model 2: Pseudo R^2: Cox-Snell & Nagelkerke
vtsiom_model_2_coxsnell <- paste(round(100*psrsq(vtsiom_model_2, method = "Cox-Snell"), digits = 1), "% (Cox-Snell)", sep = "")

vtsiom_model_2_nagelkerke <- paste(round(100*psrsq(vtsiom_model_2, method = "Nagelkerke"), digits = 1), "% (Nagelkerke)", sep = "")

# VTSIOM, Model 2: plot labels
vtsiom_model_2_labels <- c("Kaupungin tapainen taajama",
                           "Alle 50,000 asukkaan kaupunki",
                           "50,000–100,000 asukkaan kaupunki",
                           "100,000–500,000 asukkaan kaupunki *",
                           "500,000–950,000 asukkaan kaupunki *",
                           "Miljoonakaupunki ***",
                           "30–44-vuotiaat ***",
                           "45–59-vuotiaat ***",
                           "60-vuotiaat ja vanhemmat ***",
                           "Internetin käyttö: harvoin",
                           "Internetin käyttö: muutama kerta kuussa",
                           "Internetin käyttö: muutama kerta viikossa",
                           "Internetin käyttö: päivittäin alle 4h",
                           "Internetin käyttö: päivittäin yli 4h",
                           "Korkeakoulutettu *",
                           "Perheen taloustilanne: huono **",
                           "Perheen taloustilanne: keskinkertainen ***",
                           "Perheen taloustilanne: hyvä ***",
                           "Perheen taloustilanne: erittäin hyvä ***",
                           "Sukupuoli: mies ***",
                           "TV:n katselu: harvoin",
                           "TV:n katselu: muutama kerta kuussa **",
                           "TV:n katselu: muutama kerta viikossa ***",
                           "TV:n katselu: päivittäin alle 4h ***",
                           "TV:n katselu: päivittäin yli 4h ***")

# VTSIOM, Model 2: regression coefficients plot
vtsiom_model_2_coefs_plot <-
  vtsiom_model_2_plot_data %>% 
  ggplot(aes(x = term, y = estimate)) +
  geom_point(size = 3.5) +
  coord_flip() +
  ylim(-2.2, 2.2) +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2, color = "grey50") +
  theme_bw() +
  theme(text = element_text(family = "Times",
                            face = "bold",
                            size = 14)) +
  geom_hline(yintercept = 0, linetype = 2) +
  labs(title = "VTsIOM: Malli 2",
       subtitle = coefs,
       x = NULL,
       y = "Regressiokerroin") +
  scale_x_discrete(labels = vtsiom_model_2_labels)

# VTSIOM, Model 2: Odd ratios plot
vtsiom_model_2_ors_plot <-
  vtsiom_model_2_plot_data %>% 
  ggplot(aes(x = term, y = oratio)) +
  geom_point(size = 3.5) +
  coord_flip() +
  scale_y_log10(breaks = seq(0, 9, 1)) +
  geom_errorbar(aes(ymin = oratio_lower, ymax = oratio_upper), width = 0.2, color = "grey50") +
  theme_bw() +
  theme(text = element_text(family = "Times",
                            face = "bold",
                            size = 14)) +
  geom_hline(yintercept = 1, linetype = 2) +
  labs(title = NULL,
       subtitle = odds,
       x = NULL,
       y = "Riskiluku (logaritminen asteikko)",
              caption = bquote(atop(paste(R^2, " = ", .(vtsiom_model_2_coxsnell)),
                             paste(R^2, " = ", .(vtsiom_model_2_nagelkerke))))) +
  scale_x_discrete(labels = NULL)
# VTSIOM, Model 2: combine coeffients and odd ratios plots
vtsiom_model_2_plot <- vtsiom_model_2_coefs_plot + vtsiom_model_2_ors_plot
# VTSIOM, Model 2: print the combined plot for Model 2
vtsiom_model_2_plot
# VTSIOM: combine Model 1 and Model 2 results plots (kuva 7)
kuva_7 <- vtsiom_model_1_plot / vtsiom_model_2_plot
# VTSIOM: print the final full model plot (kuva 7)
kuva_7

```




```{r}
chronicles_sotakannatus <-
  chronicles_all %>% 
  ggplot(aes(x = date, y = prc, fill = fct_rev(support))) +
  geom_col() +
  theme_oma() +
  geom_text(aes(label = paste0(prc,"%")),
            position = position_stack(vjust = 0.5),
            size =4,
            fontface = "bold",
            family = "Times"
            ) +
  scale_fill_manual(values = c(kieltaytyy, eos, ehd_en_tue, tuen),
                    labels = rev(c("Tuen", "En tue", "En osaa sanoa", "Kieltäytyy vastaamasta"))) +
  theme(axis.text.y = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_text(angle = 30,
                                   size = 13),
        legend.title = element_text(face = "bold.italic",
                                    size = 14),
        legend.text = element_text(size = 12)
        ) +
  labs(fill = toupper("Sodan kannatus"),
       title = 'CHRONICLES: "Tuetteko Venäjän sotilasoperaatiota Ukrainan\nalueella, vai ettekö osaa sanoa tai halua vastata kysymykseen?"')



rf_response_rates2 %>% 
  group_by(result, pvm) %>% 
  summarize(rr = result_count / sum(result_count))


```

